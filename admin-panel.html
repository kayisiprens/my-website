<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arsaofisim - Admin Paneli</title>
    
    <!-- Firebase SDK -->
        <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy, limit, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Global değişkenler
        let db;
        let properties = [];
        let allPropertiesLoaded = false;



        // Firebase config'i API'den al
        async function initFirebase() {
          try {
            const response = await fetch('/.netlify/functions/firebase-config');
            const firebaseConfig = await response.json();
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            
            window.db = db;
            window.firebaseModules = {
                collection, getDocs, query, orderBy, limit, where
            };

            console.log('Firebase initialized successfully');
            
            // İlanları yükle
            await loadProperties();
            
          } catch (error) {
            console.error('Firebase initialization error:', error);
          }
        }

        // İlanları Firebase'den yükleme fonksiyonu
        async function loadProperties() {
            const featuredContainer = document.getElementById('featuredPropertiesContainer');
            const allContainer = document.getElementById('allPropertiesContainer');
            
            try {
                // İlanları Firebase'den çek
                const q = query(
                    collection(db, 'properties'),
                    orderBy('createdAt', 'desc')
                );
                
                const querySnapshot = await getDocs(q);
                properties = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Firestore Timestamp'i Date'e çevir
                    if (data.createdAt && data.createdAt.toDate) {
                        data.createdAt = data.createdAt.toDate();
                    }
                    if (data.updatedAt && data.updatedAt.toDate) {
                        data.updatedAt = data.updatedAt.toDate();
                    }
                    
                    properties.push({ id: doc.id, ...data }); // Burada syntax hatası vardı
                });
                
                if (properties.length === 0) {
                    featuredContainer.innerHTML = `
                        <div class="empty-state">
                            <h3>Henüz İlan Bulunmuyor</h3>
                            <p>Yakında yeni ilanlar eklenecektir.</p>
                        </div>
                    `;
                    allContainer.innerHTML = '';
                    return;
                }
                
                // Öne çıkan ilanları göster (ilk 6)
                const featuredProperties = properties.slice(0, 6);
                featuredContainer.innerHTML = featuredProperties.map(property => createPropertyCard(property)).join('');
                
                // Tüm ilanları hazırla
                allContainer.innerHTML = properties.map(property => createPropertyCard(property)).join('');
                allPropertiesLoaded = true;
                
            } catch (error) {
                console.error('İlanlar yüklenirken hata:', error);
                featuredContainer.innerHTML = `
                    <div class="error-state">
                        <h3>İlanlar Yüklenemedi</h3>
                        <p>Bir hata oluştu. Lütfen sayfayı yenileyin.</p>
                        <button onclick="loadProperties()" style="background: #ffd700; color: #2c3e50; border: none; padding: 10px 20px; border-radius: 5px; margin-top: 10px; cursor: pointer;">Tekrar Dene</button>
                    </div>
                `;
            }
        }

        // Sayfa yüklendiğinde Firebase'i başlat
        document.addEventListener('DOMContentLoaded', initFirebase);

    <!-- Cloudinary script -->
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #f8f9fa;
        }
        
        .admin-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            background: #2c3e50;
            color: white;
            padding: 20px;
            min-height: 100vh;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 20px 0;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            color: #ffd700;
            font-size: 24px;
            margin: 0;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
        }

        .sidebar-menu a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 12px 15px;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
            font-weight: 500;
        }

        .sidebar-menu a:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .sidebar-menu a.active {
            background: #ffd700;
            color: #2c3e50;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Main Content Styles */
        .main-content {
            padding: 30px;
        }
        
        .page-title {
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        /* Form Styles */
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }

        .form-group input[type="file"] {
            padding: 8px;
            border: 2px dashed #e1e8ed;
            background: #f8f9fa;
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            min-height: 150px;
            border: 2px dashed #e1e8ed;
            padding: 10px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .image-preview img {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .image-preview img:hover {
            transform: scale(1.05);
        }

        .submit-btn {
            background: #ffd700;
            color: #2c3e50;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        .submit-btn:hover {
            background: #ffed4e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .submit-btn:disabled {
            background: #e1e8ed;
            cursor: not-allowed;
            transform: none;
        }

        /* Property List Styles */
        .property-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .property-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .property-card:hover {
            transform: translateY(-5px);
        }

        .property-image {
            width: 100%;
            height: 200px;
            overflow: hidden;
        }

        .property-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .property-card:hover img {
            transform: scale(1.05);
        }

        .property-info {
            padding: 15px;
        }

        .property-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .property-info p {
            color: #666;
            margin: 5px 0;
        }

        .property-actions {
            padding: 15px;
            border-top: 1px solid #e1e8ed;
            display: flex;
            gap: 10px;
        }

        .edit-btn,
        .delete-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: #ffd700;
            color: #2c3e50;
        }

        .edit-btn:hover {
            background: #ffed4e;
            transform: translateY(-2px);
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .delete-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* Loading Styles */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #2c3e50;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Admin Panel</h2>
                <p id="userEmail" style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;"></p>
            </div>
            <ul class="sidebar-menu">
                <li><a href="javascript:void(0)" class="active" onclick="showSection('dashboard')">Dashboard</a></li>
                <li><a href="javascript:void(0)" onclick="showSection('add-property')">Yeni İlan Ekle</a></li>
                <li><a href="javascript:void(0)" onclick="showSection('property-list')">İlanları Düzenle</a></li>
                <li><a href="javascript:void(0)" onclick="logout()">Çıkış Yap</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section">
                <h1 class="page-title">Dashboard</h1>
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProperties">0</div>
                        <div class="stat-label">Toplam İlan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="saleProperties">0</div>
                        <div class="stat-label">Satılık İlan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="rentProperties">0</div>
                        <div class="stat-label">Kiralık İlan</div>
                    </div>
                </div>
            </div>

            <!-- Add Property Section -->
            <div id="add-property" class="section" style="display: none;">
                <h1 class="page-title">Yeni İlan Ekle</h1>
                <div class="form-container">
                    <form id="propertyForm" onsubmit="return saveProperty(event)">
                        <div class="form-group">
                            <label>İlan Başlığı</label>
                            <input type="text" name="title" required>
                        </div>
                        
                        <div class="form-group">
                            <label>İlan Tipi</label>
                            <select name="type" required>
                                <option value="">Seçiniz</option>
                                <option value="satilik">Satılık</option>
                                <option value="kiralik">Kiralık</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Fiyat</label>
                            <input type="number" name="price" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Konum</label>
                            <input type="text" name="location" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Özellikler</label>
                            <textarea name="features" rows="4"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Fotoğraflar</label>
                            <input type="file" name="images" multiple accept="image/*" onchange="previewImages(event)">
                            <div id="imagePreview" class="image-preview"></div>
                        </div>
                        
                        <button type="submit" class="submit-btn">İlanı Kaydet</button>
                    </form>
                </div>
            </div>

            <!-- Property List Section -->
            <div id="property-list" class="section" style="display: none;">
                <h1 class="page-title">İlanları Düzenle</h1>
                <div id="propertyListContainer" class="property-list">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>İlanlar yükleniyor...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// Cloudinary yapılandırması
const cloudinaryConfig = {
    cloudName: 'ddoy6aifm',
    uploadPreset: 'arsaofisim_preset'
};

// Global değişkenler
let currentEditingId = null;
let properties = [];

// Sayfa yüklendiğinde çalışacak kodlar
document.addEventListener('DOMContentLoaded', function() {
    // Auth state kontrolü
    setTimeout(() => {
        if (window.auth && window.firebaseModules) {
            window.firebaseModules.onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    document.getElementById('userEmail').textContent = user.email;
                    showSection('dashboard');
                    loadProperties();
                    updateDashboardStats();
                } else {
                    window.location.href = 'admin-login.html';
                }
            });
        } else {
            console.error('Firebase modülleri yüklenemedi!');
            alert('Firebase bağlantısı kurulamadı. Lütfen internet bağlantınızı kontrol edin.');
        }
    }, 1000);
});

// Resim yükleme fonksiyonu
async function uploadImages(files) {
    const uploadedUrls = [];
    
    for(let file of files) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', cloudinaryConfig.uploadPreset);
        
        try {
            const response = await fetch(
                `https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`,
                {
                    method: 'POST',
                    body: formData
                }
            );
            
            const data = await response.json();
            uploadedUrls.push(data.secure_url);
        } catch (error) {
            console.error('Resim yükleme hatası:', error);
        }
    }
    
    return uploadedUrls;
}

// Resim önizleme
function previewImages(event) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    const files = event.target.files;
    for(let i = 0; i < files.length; i++) {
        const file = files[i];
        if(!file.type.startsWith('image/')) continue;
        
        const img = document.createElement('img');
        img.style.maxWidth = '150px';
        img.style.maxHeight = '150px';
        img.style.margin = '5px';
        preview.appendChild(img);
        
        const reader = new FileReader();
        reader.onload = (function(aImg) { 
            return function(e) { 
                aImg.src = e.target.result; 
            }; 
        })(img);
        reader.readAsDataURL(file);
    }
}

// İlan kaydetme fonksiyonu
async function saveProperty(event) {
    event.preventDefault();
    
    if (!window.db || !window.firebaseModules) {
        alert('Firebase bağlantısı kurulamadı!');
        return false;
    }

    const submitButton = event.target.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.innerHTML;
    submitButton.innerHTML = 'Yükleniyor...';
    submitButton.disabled = true;
    
    try {
        const formData = new FormData(event.target);
        const propertyData = {
            title: formData.get('title'),
            type: formData.get('type'),
            price: Number(formData.get('price')),
            location: formData.get('location'),
            features: formData.get('features'),
            images: [],
            createdAt: new Date(),
            updatedAt: new Date()
        };
        
        // Resimleri yükle
        const imageFiles = formData.getAll('images');
        if(imageFiles.length > 0) {
            propertyData.images = await uploadImages(imageFiles);
        }
        
        if (currentEditingId) {
            // Güncelleme işlemi
            const docRef = window.firebaseModules.doc(window.db, 'properties', currentEditingId);
            propertyData.updatedAt = new Date();
            await window.firebaseModules.updateDoc(docRef, propertyData);
            alert('İlan başarıyla güncellendi!');
            currentEditingId = null;
        } else {
            // Yeni ekleme işlemi
            await window.firebaseModules.addDoc(window.firebaseModules.collection(window.db, 'properties'), propertyData);
            alert('İlan başarıyla kaydedildi!');
        }
        
        event.target.reset();
        document.getElementById('imagePreview').innerHTML = '';
        loadProperties();
        updateDashboardStats();
        
    } catch (error) {
        console.error('Hata:', error);
        alert('Bir hata oluştu: ' + error.message);
    } finally {
        submitButton.innerHTML = originalButtonText;
        submitButton.disabled = false;
    }
    
    return false;
}

// İlanları yükleme fonksiyonu
async function loadProperties() {
    if (!window.db || !window.firebaseModules) return;

    const container = document.getElementById('propertyListContainer');
    
    try {
        container.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>İlanlar yükleniyor...</p>
            </div>
        `;

        const q = window.firebaseModules.query(
            window.firebaseModules.collection(window.db, 'properties'),
            window.firebaseModules.orderBy('createdAt', 'desc')
        );
        
        const querySnapshot = await window.firebaseModules.getDocs(q);
        properties = [];
        
        querySnapshot.forEach((doc) => {
            properties.push({id: doc.id,...doc.data() });
        });
        
        if(properties.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Henüz ilan bulunmuyor.</p>';
            return;
        }
        
        container.innerHTML = properties.map(property => `
            <div class="property-card">
                <div class="property-image">
                    ${property.images && property.images.length > 0 ? 
                        `<img src="${property.images[0]}" alt="${property.title}">` : 
                        '<div class="no-image">🏠</div>'
                    }
                </div>
                <div class="property-info">
                    <h3>${property.title}</h3>
                    <p>📍 ${property.location}</p>
                    <p>💰 ₺${Number(property.price).toLocaleString()}</p>
                    <p>🏷️ ${property.type === 'satilik' ? 'Satılık' : 'Kiralık'}</p>
                </div>
                <div class="property-actions">
                    <button class="edit-btn" onclick="editProperty('${property.id}')">Düzenle</button>
                    <button class="delete-btn" onclick="deleteProperty('${property.id}')">Sil</button>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('İlanlar yüklenirken hata:', error);
        container.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 2rem;">İlanlar yüklenirken hata oluştu.</p>';
    }
}

// Dashboard istatistiklerini güncelle
async function updateDashboardStats() {
    if (!properties.length) return;

    const total = properties.length;
    const sale = properties.filter(p => p.type === 'satilik').length;
    const rent = properties.filter(p => p.type === 'kiralik').length;

    document.getElementById('totalProperties').textContent = total;
    document.getElementById('saleProperties').textContent = sale;
    document.getElementById('rentProperties').textContent = rent;
}

// İlan düzenleme fonksiyonu
function editProperty(id) {
    const property = properties.find(p => p.id === id);
    
    if(property) {
        currentEditingId = id;
        showSection('add-property');
        
        const form = document.getElementById('propertyForm');
        form.elements['title'].value = property.title;
        form.elements['type'].value = property.type;
        form.elements['price'].value = property.price;
        form.elements['location'].value = property.location;
        form.elements['features'].value = property.features || '';
        
        const preview = document.getElementById('imagePreview');
        if (property.images && property.images.length > 0) {
            preview.innerHTML = property.images.map(url => 
                `<img src="${url}" style="max-width:150px;max-height:150px;margin:5px;">`
            ).join('');
        }
        
        // Buton tekstini değiştir
        const submitBtn = form.querySelector('.submit-btn');
        submitBtn.textContent = 'İlanı Güncelle';
    }
}

// İlan silme fonksiyonu
async function deleteProperty(id) {
    if(!confirm('Bu ilanı silmek istediğinizden emin misiniz?')) return;
    
    if (!window.db || !window.firebaseModules) {
        alert('Firebase bağlantısı kurulamadı!');
        return;
    }

    try {
        await window.firebaseModules.deleteDoc(window.firebaseModules.doc(window.db, 'properties', id));
        alert('İlan başarıyla silindi!');
        loadProperties();
        updateDashboardStats();
    } catch (error) {
        console.error('Silme hatası:', error);
        alert('İlan silinirken hata oluştu: ' + error.message);
    }
}

// Seksiyon gösterme fonksiyonu
function showSection(sectionId) {
    // Editing modunu sıfırla
    if (sectionId !== 'add-property') {
        currentEditingId = null;
        const form = document.getElementById('propertyForm');
        if (form) {
            form.reset();
            document.getElementById('imagePreview').innerHTML = '';
            form.querySelector('.submit-btn').textContent = 'İlanı Kaydet';
        }
    }
    
    document.querySelectorAll('.section').forEach(section => {
        section.style.display = 'none';
    });
    
    const selectedSection = document.getElementById(sectionId);
    if(selectedSection) {
        selectedSection.style.display = 'block';
    }
    
    document.querySelectorAll('.sidebar-menu a').forEach(link => {
        link.classList.remove('active');
    });
    
    const activeLink = document.querySelector(`.sidebar-menu a[onclick*="${sectionId}"]`);
    if(activeLink) {
        activeLink.classList.add('active');
    }

    // Dashboard'a geçince istatistikleri güncelle
    if (sectionId === 'dashboard') {
        updateDashboardStats();
    }
}

// Çıkış yapma fonksiyonu
async function logout() {
    if(!confirm('Çıkış yapmak istediğinize emin misiniz?')) return;
    
    if (!window.auth || !window.firebaseModules) {
        window.location.href = 'index.html';
        return;
    }

    try {
        await window.firebaseModules.signOut(window.auth);
        window.location.href = 'index.html';
    } catch (error) {
        console.error('Çıkış hatası:', error);
        alert('Çıkış yaparken hata oluştu');
    }
}

// Hata yakalama
window.addEventListener('error', function(e) {
    console.error('Global hata:', e.error);
});
</script>
</body>
</html>